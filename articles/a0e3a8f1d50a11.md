---
title: "SORACOM CLI + Power Shellã§VPGã®ãƒ‡ãƒã‚¤ã‚¹LANè¨­å®šã‚’ç§»è¡Œã™ã‚‹"
emoji: "ğŸŒ"
type: "tech"
topics:
  - "soracom"
published: true
published_at: "2024-01-24 17:04"
---

:::message
ã€Œ[ä¸€èˆ¬æ¶ˆè²»è€…ãŒäº‹æ¥­è€…ã®è¡¨ç¤ºã§ã‚ã‚‹ã“ã¨ã‚’åˆ¤åˆ¥ã™ã‚‹ã“ã¨ãŒå›°é›£ã§ã‚ã‚‹è¡¨ç¤º](https://www.caa.go.jp/policies/policy/representation/fair_labeling/guideline/assets/representation_cms216_230328_03.pdf)ã€ã®é‹ç”¨åŸºæº–ã«åŸºã¥ãé–‹ç¤º: ã“ã®è¨˜äº‹ã¯è¨˜è¼‰ã®æ—¥ä»˜æ™‚ç‚¹ã§[æ ªå¼ä¼šç¤¾ã‚½ãƒ©ã‚³ãƒ ](https://soracom.jp/)ã«æ‰€å±ã™ã‚‹ç¤¾å“¡ãŒåŸ·ç­†ã—ã¾ã—ãŸã€‚ãŸã ã—ã€å€‹äººã¨ã—ã¦ã®æŠ•ç¨¿ã§ã‚ã‚Šã€æ ªå¼ä¼šç¤¾ã‚½ãƒ©ã‚³ãƒ ã¨ã—ã¦ã®æ­£å¼ãªç™ºè¨€ã‚„è¦‹è§£ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::


## ã‚„ã‚ŠãŸã„ã“ã¨
SORACOM Gateã‚’ä½¿ã†ã¨ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ï¼ˆGate C2Dï¼‰ã¾ãŸã¯ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ï¼ˆGate D2Dï¼‰ã«å¯¾ã—ã¦IPã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã®æ™‚ã€ãƒ‡ãƒã‚¤ã‚¹ï¼ˆSIMï¼‰ã«æŒ¯ã‚‰ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ãŒã€VPGã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒƒãƒ—ã®è¨­å®šã‚’è¡Œã†ã“ã¨ã§ã€ãƒ‡ãƒã‚¤ã‚¹ï¼ˆSIMï¼‰ã«æŒ¯ã‚‰ã‚Œã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å›ºå®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆé€†ã«ã“ã‚Œã‚’ã‚„ã‚‰ãªã„å ´åˆã€DHCPçš„ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæŒ¯ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ï¼‰ã€‚

ã“ã®è¨­å®šãŒã•ã‚ŒãŸVPGã‚’ä½•ã‚‰ã‹ã®ç†ç”±ã§åˆ¥ã®VPGã«ç§»è¡Œã—ãŸã„å ´åˆã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿæ–½ã™ã‚‹ã¨ã€SIMã®IMSIã¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã®å¯¾å¿œã‚’ä¸€ã¤ä¸€ã¤æ‰‹å…¥åŠ›ã§å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¦ã—ã¾ã„ã€ã™ã§ã«å¤§é‡ã®è¨­å®šãŒã—ã¦ã‚ã‚‹VPGã‚’ç§»è¡Œã™ã‚‹ã®ã¯å¤§å¤‰ãªä½œæ¥­ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/87f14367b53b-20240124.png)

ä»Šå›ã®ãƒ–ãƒ­ã‚°ã§ã¯ã“ã®è¨­å®šã‚’SORACOM CLIã‚’åˆ©ç”¨ã—ã¦åŠ¹ç‡çš„ã«å®Ÿæ–½ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## æº–å‚™

### 1. PowerShellã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
https://github.com/PowerShell/PowerShell/releases

### 2. SORACOM-CLIã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
åŸºæœ¬çš„ã«ã“ã¡ã‚‰ã®é€šã‚Šã€‚
https://users.soracom.io/ja-jp/tools/cli/getting-started/

#### 2.1. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã£ãŸã‚‚ã®ã‚’ã©ã†ã
https://github.com/soracom/soracom-cli/releases

#### 2.2. èªè¨¼æƒ…å ±ã®æº–å‚™
https://users.soracom.io/ja-jp/tools/cli/getting-started/?tab-2-3=selected#%e3%82%b9%e3%83%86%e3%83%83%e3%83%97-2-%e8%aa%8d%e8%a8%bc%e6%83%85%e5%a0%b1%e3%82%92%e6%ba%96%e5%82%99%e3%81%99%e3%82%8b

ã“ã“ã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã€åŸºæœ¬çš„ã«SAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼æƒ…å ±ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚ã¨ã„ã†ã“ã¨ã§ã€ã“ã¡ã‚‰ã€€https://users.soracom.io/ja-jp/docs/sam/create-sam-user/ã€€ã®æ‰‹é †ã«æ²¿ã£ã¦ã‚„ã£ã¦ã„ãã¾ã™ã€‚
èªè¨¼ã‚­ãƒ¼ã¯ç„¡ãã•ãªã„ã‚ˆã†ã«å¤§äº‹ã«ã—ã¾ã£ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

#### 2.3. èªè¨¼æƒ…å ±ã®ä¿å­˜
https://users.soracom.io/ja-jp/tools/cli/getting-started/?tab-2-3=selected#%e3%82%b9%e3%83%86%e3%83%83%e3%83%97-3-%e8%aa%8d%e8%a8%bc%e6%83%85%e5%a0%b1%e3%82%92%e4%bf%9d%e5%ad%98%e3%81%99%e3%82%8b

ã“ã“ã¾ã§çµ‚ã‚ã£ãŸã‚‰SORACOM CLIãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## ç·´ç¿’
ï¼ˆã ã„ãŸã„ã‚ã‹ã£ã¦ã‚‹ã‹ã‚‰ã¯ã‚ˆæœ¬é¡Œã«å…¥ã‚Œã‚„ã¨ã„ã†äººã¯é£›ã°ã—ã¦ãã ã•ã„ã€‚ï¼‰
è©¦ã—ã«ã€æŒã£ã¦ã„ã‚‹SIMã®ä¸€è¦§ã‚’å¼•ãå‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```
soracom sims list
```
ã“ã‚“ãªæ„Ÿã˜ã®ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§`[{"activeProfileId":`ã‹ã‚‰å§‹ã¾ã‚‹JSONé…åˆ—ãŒãƒ™ãƒ­ãƒ™ãƒ­å‡ºã¦ããŸã‚‰å¤§æˆåŠŸ
![](https://storage.googleapis.com/zenn-user-upload/3dca1a7dd532-20230629.png)


## æœ¬ç•ª
ã„ã‚ˆã„ã‚ˆã“ã“ã‹ã‚‰ã§ã™ã€‚
ç§»è¡Œå¾Œã®VPGã¯ä½œæˆæ¸ˆã¿ã®å‰æã§ã™ã€‚

### vpgã®æƒ…å ±ã‚’ç¢ºèªã—ã¦å¤‰æ•°ã«å…¥ã‚Œã‚‹

ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¿ã‚¤ãƒ—ã‚’é¸ã‚“ã§ãŠãã¾ã™ã€‚
ä»¥ä¸‹ã¯æ—¥æœ¬ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ä¾‹ï¼ˆplan-D,plan-Kãªã©ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆï¼‰
```PowerShell
$coverage = "jp"
```

ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆplan01s,planP1,planX3ãªã©ï¼‰ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€`"g"`ã¨ã—ã¾ã—ã‚‡ã†ã€‚

å·¦ä¸Šãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ -> ã€ŒSORAOM AIR FOR ã‚»ãƒ«ãƒ©ãƒ¼ã€ -> ã€Œ[VPG](https://console.soracom.io/virtual_private_gateways)ã€
ã§VPGã®ä¸€è¦§ã‚’è¡¨ç¤ºã€‚

ç§»è¡Œå‰/å¾Œã®VPGã®IDã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
![](https://storage.googleapis.com/zenn-user-upload/59ea89c342bf-20240124.png)

ç¢ºèªã—ãŸã‚‰ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã€å¤‰æ•°ï¼ˆ`vpg_id_before`,`vpg_id_after`ï¼‰ã«å…¥ã‚Œã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```PowerShell
$vpg_id_before="<ã‚³ãƒ”ãƒ¼ã—ãŸç§»è¡Œå…ƒã®VPGã®ID>"
$vpg_id_after="<ã‚³ãƒ”ãƒ¼ã—ãŸç§»è¡Œå…ˆã®VPGã®ID>"
```

### ç§»è¡Œå‰ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒƒãƒ—æƒ…å ±ã‚’å–å¾—ã™ã‚‹

`soracom vpg list-ip-address-map-entries`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚

ã‚³ãƒãƒ³ãƒ‰ã®çµæœã¯JSONã§å¸°ã£ã¦ãã‚‹ã®ã§ã€æ‰±ã„ã‚„ã™ã„å½¢ã«ãƒ‘ãƒ¼ã‚¹ã—ã¦`entries`ã¨ã„ã†å¤‰æ•°ã«å…¥ã‚Œã¾ã™ã€‚

```PowerShell
$entries = soracom vpg list-ip-address-map-entries --vpg-id $vpg_id_before --coverage-type $coverage| ConvertFrom-Json
```
ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚‰ä¸­èº«ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```PowerShell
$entries
```
ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§å‡ºã¦ã„ã‚Œã°OKã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/5c7067b69624-20240124.png)

ã“ã®ã†ã¡typeãŒstaticã¨ãªã£ã¦ã„ã‚‹ã‚¨ãƒ³ãƒˆãƒªãŒIPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒƒãƒ—ã«é–¢ã™ã‚‹è¨­å®šã¨ãªã£ã¦ã„ã¾ã™ã€‚

### æ–°ã—ã„VPGã«è¨­å®šã‚’è¿½åŠ 

#### APIKeyã¨tokenã‚’ä½¿ã„ã¾ã‚ã›ã‚‹ã‚ˆã†ã«å¤‰æ•°ã«å…¥ã‚Œã‚‹
ä»Šå›ä½¿ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ã€å®Ÿè¡Œã™ã‚‹ãŸã³ã« API ã‚­ãƒ¼ã¨ API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã¾ãŸã€ä»Šå›ã¯1å›ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã§ã€1ã¤ã®ã‚¨ãƒ³ãƒˆãƒªã—ã‹è¨­å®šã§ããªã„ãŸã‚ã€ SORACOM CLI ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¤‡æ•°å›å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é–‹å§‹æ™‚ã« 1 å›ã ã‘ soracom auth (Auth:auth API) ã‚’å®Ÿè¡Œã—ã¦ API ã‚­ãƒ¼ã¨ API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã€ãã‚Œã‚‰ã‚’å†åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å…¨ä½“ã®å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã§ãã¾ã™ã€‚

ã¾ãšã¯authKeyIdã¨authKeyã‚’å…¥æ‰‹ã—ã¦ã€å¤‰æ•°ã®ä¸­ã«å…¥ã‚Œã¾ã™ã€‚
```powershell
$config = soracom configure get | convertFrom-Json
$auth_key_id = $config.authKeyId
$auth_key = $config.authKey
```

authKeyã¨authKeyIdã‚’ä½¿ã£ã¦APIã‚­ãƒ¼ã¨APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥æ‰‹ï¼ˆAPIã‚­ãƒ¼ã¨ APIãƒˆãƒ¼ã‚¯ãƒ³ãŒå«ã¾ã‚Œã‚‹JSONã‚’å…¥æ‰‹ï¼‰ã—ã¾ã™ã€‚
APIã‚­ãƒ¼ã¨ APIãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã¯ '--token-timeout-seconds' 3600 ã®éƒ¨åˆ†ã®ç§’æ•°ã§ã™ã€‚
```powershell
$auth_info = soracom auth --auth-key-id $auth_key_id --auth-key $auth_key --token-timeout-seconds 3600 | ConvertFrom-Json
```

å…ˆã»ã©å…¥æ‰‹ã—ãŸJSONã‹ã‚‰ã‚­ãƒ¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’`$auth_key_id`ã¨`$auth_key`ã«ã„ã‚Œã¾ã™ã€‚
```powershell
$api_key = $auth_info.apiKey
$api_token = $auth_info.token
```

#### ãƒ‡ãƒã‚¤ã‚¹ã«å¯¾ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¨­å®šã®ã¿æŠ½å‡ºã—ã¦ãã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’è¨­å®šã™ã‚‹


typeãŒstaticã«ãªã£ã¦ã„ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

```PowerShell
 $filteredEntries = $entries | Where-Object { $_.type -eq "static" }
```


`soracom vpg put-ip-address-map-entry`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚ãŸã ã—ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ï¼‘ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãšã¤ã—ã‹è¨­å®šã§ããªã„ã®ã§ã€foreachã‚’ä½¿ã„ã¾ã™ã€‚
å¿µã®ç‚ºã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

 ```PowerShell
# é€²æ—ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªã‚»ãƒƒãƒˆ
$successCount = 0

foreach ($entry in $filteredEntries) {
    $body = @{
        ipAddress = $entry.ipAddress
        key = $entry.key
    } | ConvertTo-Json

    try {
        # ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ã®ä½œæˆ
        $command = "soracom vpg put-ip-address-map-entry --body '$body' --vpg-id '$vpg_id_after' --coverage-type '$coverage' --api-key '$api_key' --api-token '$api_token'"

        # ä½œæˆã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        $output = Invoke-Expression $command

        # æ­£å¸¸ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã©ã†ã‹ã‚’ç¢ºèª
        $responseJson = $output | ConvertFrom-Json
        if ($responseJson.ipAddress -eq $entry.ipAddress -and $responseJson.key -eq $entry.key) {
            $successCount++
            # é€²æ—è¡¨ç¤º
            Write-Host "æˆåŠŸã—ãŸã‚¨ãƒ³ãƒˆãƒªã®æ•°: $successCount / $($filteredEntries.Count)"
        } else {
            Write-Host "ã‚¨ãƒ©ãƒ¼: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® ipAddress ã¾ãŸã¯ key ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"
            break # ä¸€è‡´ã—ãªã„å ´åˆã€ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã—ã¾ã™
        }
    }
    catch {
        Write-Host "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Message)"
        break # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã—ã¾ã™
    }
}
```
å®Ÿè¡Œçµæœã®ä¾‹
![](https://storage.googleapis.com/zenn-user-upload/df31de2afdb5-20240124.png)