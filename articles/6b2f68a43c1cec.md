---
title: "Robustel R1520ã§GPSãƒ‡ãƒ¼ã‚¿ã‚’ã¨ã£ã¦ã¿ãŸ"
emoji: "ğŸ›°ï¸"
type: "tech"
topics:
  - "python"
  - "iot"
  - "gps"
  - "gnss"
  - "nmea"
published: true
published_at: "2024-05-27 21:33"
---

:::message
ã€Œ[ä¸€èˆ¬æ¶ˆè²»è€…ãŒäº‹æ¥­è€…ã®è¡¨ç¤ºã§ã‚ã‚‹ã“ã¨ã‚’åˆ¤åˆ¥ã™ã‚‹ã“ã¨ãŒå›°é›£ã§ã‚ã‚‹è¡¨ç¤º](https://www.caa.go.jp/policies/policy/representation/fair_labeling/guideline/assets/representation_cms216_230328_03.pdf)ã€ã®é‹ç”¨åŸºæº–ã«åŸºã¥ãé–‹ç¤º: ã“ã®è¨˜äº‹ã¯è¨˜è¼‰ã®æ—¥ä»˜æ™‚ç‚¹ã§[æ ªå¼ä¼šç¤¾ã‚½ãƒ©ã‚³ãƒ ](https://soracom.jp/)ã«æ‰€å±ã™ã‚‹ç¤¾å“¡ãŒåŸ·ç­†ã—ã¾ã—ãŸã€‚ãŸã ã—ã€å€‹äººã¨ã—ã¦ã®æŠ•ç¨¿ã§ã‚ã‚Šã€æ ªå¼ä¼šç¤¾ã‚½ãƒ©ã‚³ãƒ ã¨ã—ã¦ã®æ­£å¼ãªç™ºè¨€ã‚„è¦‹è§£ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::

# ã‚„ã‚ŠãŸã„ã“ã¨

IoTãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹éš›ã«GPSãªã©ã®GNSSã«ã‚ˆã‚‹æ¸¬ä½ãƒ‡ãƒ¼ã‚¿ã‚’è¼‰ã›ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ã‚„ã‚Šæ–¹ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ãŸæ§‹æˆã§è€ƒãˆã¦ã¿ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/3adaae027f58-20240527.png)


ã¡ãªã¿ã«ã“ã®æ§‹æˆãŒæœ€é©è§£ã¨ãªã‚‰ãªã„å ´åˆã‚‚ã‚ã‚‹ãŸã‚ã€ä»–ã®é¸æŠè‚¢ã‚’æŒ™ã’ã¦ãŠãã¾ã™ã®ã§æ¯”è¼ƒæ¤œè¨ã—ãŸã†ãˆã§ã“ã®æ§‹æˆã‚’ä½¿ã£ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
- GNSSå¯¾å¿œLTEãƒ«ãƒ¼ã‚¿ãƒ¼ãŒæ¸¬ä½ãƒ‡ãƒ¼ã‚¿ã®ã¿ç›´æ¥é€ä¿¡ã™ã‚‹
(ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€£æºã™ã‚‹å¿…è¦ã‚ã‚Šï¼‰
- GNSSéå¯¾å¿œãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã„ã€GPSãƒˆãƒ©ãƒƒã‚«ãƒ¼ã‚’åˆ¥ã§ç”¨æ„ã—ã¦æ¸¬ä½ãƒ‡ãƒ¼ã‚¿ã®ã¿ç›´æ¥é€ä¿¡ã™ã‚‹
(ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€£æºã™ã‚‹å¿…è¦ã‚ã‚Šï¼‰
- ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿å´ã«GPSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ¥ç¶šã™ã‚‹


# ç’°å¢ƒ
- Robustel R1520-4L
    - LTE ã‚¢ãƒ³ãƒ†ãƒŠ
    - GPS ã‚¢ãƒ³ãƒ†ãƒŠ
- SORACOM IoT SIM
- PC ï¼ˆæœ¬ãƒ–ãƒ­ã‚°ã§ã¯ã€M2 Mac Book Proã‚’ä½¿ç”¨ï¼‰
    - Python 3.11.7
    - ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆæœ¬ãƒ–ãƒ­ã‚°ã§ã¯Google Chrome ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 125.0.6422.112ï¼ˆOfficial Buildï¼‰ ï¼ˆarm64ï¼‰)
- LANã‚±ãƒ¼ãƒ–ãƒ«

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
1. R1520ã®SIM1ã‚¹ãƒ­ãƒƒãƒˆã«SORACOM IoT SIMã‚’æŒ¿å…¥
2. PCã®Ethernetãƒãƒ¼ãƒˆã¨ã€R1520ã®ETH0ãƒãƒ¼ãƒˆã‚’LANã‚±ãƒ¼ãƒ–ãƒ«ã§æ¥ç¶š
4. PCã®Ethernetãƒãƒ¼ãƒˆã‚’DHCPã«è¨­å®šï¼ˆR1520ã®DHCPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ã„ã¾ã™ï¼‰
6. R1520ã‚’èµ·å‹•ï¼ˆACã‚¢ãƒ€ãƒ—ã‚¿ã‚’æ¥ç¶šã—ã€é›»æºä¾›çµ¦ã‚’é–‹å§‹ã™ã‚‹ï¼‰
7. http://192.168.0.1ã€€ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€é©åˆ‡ãªusername,passwordã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³
![](https://storage.googleapis.com/zenn-user-upload/83cb164b41d6-20240526.png)


# æ‰‹é †
## R1520ã‚’ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
Interface ã‹ã‚‰WWAN1ã‚’Primary Linkã«ã—ã¾ã™ã€‚
(è¨­å®šã‚’submitã—ãŸã‚‰Save&Apply)
![](https://storage.googleapis.com/zenn-user-upload/6ffb131eaa7f-20240526.png)

ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c64cd0c3710d-20240526.png)

ã„ã¤ã‚‚ã®APNã‚„user,passwordã‚’å…¥ã‚Œã¦ãªã„ã‘ã©å¤§ä¸ˆå¤«ã‹ï¼Ÿã¨æ€ã„ã¾ã™ãŒã€Automatic APN SelectionãŒåŠ¹ã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c6b9262174b6-20240526.png)

APNã‚’æ‰‹å‹•ã§è¨­å®šã™ã‚‹å ´åˆã®è¨­å®šã¯ã“ã‚“ãªæ„Ÿã˜ã§ã„ã‘ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/4a4dff165b48-20240527.png)

## R1520ã®GPSã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
GPSã®ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã¯ã€ŒServicesã€ -> ã€ŒGPSã€ã®ã¨ã“ã‚ã«ã‚ã‚Šã¾ã™ã€‚

Gneneral Settingsã®Enable GPSã¨ã€Sync GPSã‚’ONã«ã—ã¦GPSã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/974010fe277b-20240526.png)

RS232 Report Settingsã¯ã‚·ãƒªã‚¢ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰NMEAãƒ‡ãƒ¼ã‚¿ã‚’å‚ã‚Œæµã—ã«ã™ã‚‹æ©Ÿèƒ½ã®ã‚ˆã†ã§ã™ãŒã€ä»Šå›ã¯ä½¿ã„ã¾ã›ã‚“ã€‚

ä¸­æ®µã«ã‚ã‚‹ã€ŒGPS Serversã€ã®å³ç«¯ã®ã€Œï¼‹ã€ã‚’æŠ¼ã—ã¦ã€è¨­å®šã‚’é–‹ãã¾ã™ã€‚
Local Aderessã¯ã“ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã®LANå´IPã‚’è¨­å®šã—ã¦ã€Local Portã¯ãŠå¥½ã¿ã®ãƒãƒ¼ãƒˆã‚’å…¥ã‚Œã¾ã™ã€‚
ï¼ˆä»Šå›ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®LANå´I/Fã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ã‚‹ã€192.168.0.1ã¨ã€ãªã‚“ã¨ãªã50010ãƒãƒ¼ãƒˆã‚’è¨­å®šã—ã¦ã€ã™ã¹ã¦ã®sentenceã‚’ONã«ã—ã¾ã—ãŸã€‚ï¼‰
![](https://storage.googleapis.com/zenn-user-upload/2f9cbf547d37-20240526.png)

submitã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å³ä¸Šã®ã€ŒSave&Applyã€ãŒé»„è‰²ããªã‚Šã¾ã™ã®ã§ã€ãã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚

ä¸€æ—¦Rebootï¼ˆãŠã¾ã˜ãªã„ï¼‰ã—ã¦ã€å†åº¦http://192.168.0.1ã€€ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

ã€ŒServicesã€ -> ã€ŒGPSã€ã§ã€ŒStatusã€ã‚¿ãƒ–ã‚’é–‹ãã¾ã™ã€‚
ã¡ã‚ƒã‚“ã¨æ¸¬ä½ãŒã§ãã¦ã„ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/4f9e20256be2-20240526.png)

## ãƒ«ãƒ¼ã‚¿ãƒ¼é…ä¸‹ã«æ¥ç¶šã—ãŸPCã§R1520ã‹ã‚‰NMEAãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
R1520ã®GPS Serverã«å¯¾ã—ã¦æ‰‹å‹•ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
curl -v telnet://192.168.0.1:50010
```
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€192.168.0.1:50010ã«TCPã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼µã£ã¦ã€ãªã‚“ã ã‹ãã‚Œã£ã½ã„ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã‚Œã°OKã¨ãªã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/f98789581261-20240526.png)

ã“ã“ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ä½•ã‹ãŒãŠã‹ã—ã„ã®ã§å„ç¨®è¨­å®šã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

ã“ã“ã¾ã§ã§å‹•ãã¯ã‚ã‹ã£ãŸã¨ãŠã‚‚ã„ã¾ã™ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚ã‚‹PCã‹ã‚‰TCPã®ã‚½ã‚±ãƒƒãƒˆã‚’æ¥ç¶šã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒé™ã£ã¦ãã‚‹ã¨ã„ã†ä»•çµ„ã¿ã®ã‚ˆã†ã§ã™ã€‚

### pythonã§ã¨ã£ã¦SORACOM Harvest Dataã«æŠ•ã’ã¦ã¿ã‚‹
ã‚ã¨ã¯TCPã‚½ã‚±ãƒƒãƒˆã‚’é–‹ã„ã¦ã€ãƒãƒƒãƒ•ã‚¡ã«æŠ•ã’è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã„ã„æ„Ÿã˜ã«æ•´å½¢ã—ã¦å¾Œæ®µã®å‡¦ç†ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã‚ã’ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™ã€‚

ä½œã£ãŸpythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

å„éƒ¨ã®è§£èª¬ã¯ã‚³ãƒ¼ãƒ‰ã®å¾Œã‚ã«è¨˜è¼‰ã—ã¾ã™ã€‚
:::details ã‚³ãƒ¼ãƒ‰æœ¬ä½“ï¼ˆâ–¶ï¸ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ãï¼‰
```python
import socket
import time
import json
import requests

def parse_nmea_sentence(sentence):
    parts = sentence.split(',')
    if sentence.startswith("$GPGGA"):
        return {
            "type": "GPGGA",
            "time": parts[1],
            "latitude": parts[2],
            "latitude_direction": parts[3],
            "longitude": parts[4],
            "longitude_direction": parts[5],
            "quality": parts[6],
            "num_satellites": parts[7],
            "horizontal_dilution": parts[8],
            "altitude": parts[9],
            "altitude_units": parts[10],
            "geoid_separation": parts[11],
            "geoid_separation_units": parts[12],
            "age_of_diff_corr": parts[13] if len(parts) > 13 else None,
            "diff_ref_station_id": parts[14].split('*')[0] if len(parts) > 14 else None
        }
    elif sentence.startswith("$GPRMC"):
        return {
            "type": "GPRMC",
            "time": parts[1],
            "status": parts[2],
            "latitude": parts[3],
            "latitude_direction": parts[4],
            "longitude": parts[5],
            "longitude_direction": parts[6],
            "speed_over_ground": parts[7],
            "track_angle": parts[8],
            "date": parts[9],
            "magnetic_variation": parts[10] if len(parts) > 10 else None,
            "magnetic_variation_direction": parts[11].split('*')[0] if len(parts) > 11 else None
        }
    elif sentence.startswith("$GPVTG"):
        return {
            "type": "GPVTG",
            "true_track_degrees": parts[1],
            "true_track_indicator": parts[2],
            "magnetic_track_degrees": parts[3],
            "magnetic_track_indicator": parts[4],
            "ground_speed_knots": parts[5],
            "ground_speed_knots_unit": parts[6],
            "ground_speed_kmph": parts[7],
            "ground_speed_kmph_unit": parts[8].split('*')[0]
        }
    elif sentence.startswith("$GPGSV"):
        return {
            "type": "GPGSV",
            "num_messages": parts[1],
            "message_number": parts[2],
            "num_sv_in_view": parts[3],
            "sv_info": parts[4:]
        }
    elif sentence.startswith("$GNGSA"):
        return {
            "type": "GNGSA",
            "mode": parts[1],
            "fix_type": parts[2],
            "satellite_ids": parts[3:15],
            "pdop": parts[15],
            "hdop": parts[16],
            "vdop": parts[17].split('*')[0]
        }
    elif sentence.startswith("$GNGNS"):
        return {
            "type": "GNGNS",
            "time": parts[1],
            "latitude": parts[2],
            "latitude_direction": parts[3],
            "longitude": parts[4],
            "longitude_direction": parts[5],
            "mode_indicator": parts[6],
            "num_satellites": parts[7],
            "hdop": parts[8],
            "altitude": parts[9],
            "geoid_separation": parts[10],
            "dgps_age": parts[11],
            "dgps_station_id": parts[12].split('*')[0]
        }
    elif sentence.startswith("$GLGSV"):
        return {
            "type": "GLGSV",
            "num_messages": parts[1],
            "message_number": parts[2],
            "num_sv_in_view": parts[3],
            "sv_info": parts[4:]
        }
    return None

def parse_nmea_sentences(sentences):
    parsed_data = {
        "GPGGA": None,
        "GPRMC": None,
        "GPVTG": None,
        "GPGSV": None,
        "GNGSA": None,
        "GNGNS": None,
        "GLGSV": None
    }
    
    for sentence in sentences:
        parsed_sentence = parse_nmea_sentence(sentence)
        if parsed_sentence:
            parsed_data[parsed_sentence["type"]] = parsed_sentence

    return parsed_data

def convert_nmea_to_decimal(degree_minutes, direction):
    if not degree_minutes:
        return None
    parts = degree_minutes.split(".")
    if len(parts) != 2:
        return None
    degrees = int(parts[0][:-2])
    minutes = float(parts[0][-2:] + "." + parts[1])
    decimal_degrees = degrees + minutes / 60
    if direction in ['S', 'W']:
        decimal_degrees = -decimal_degrees
    return decimal_degrees

def post_data(url, data):
    headers = {'Content-Type': 'application/json'}
    try:
        response = requests.post(url, headers=headers, json=data)
        print(f"POST {url} - Status Code: {response.status_code}")
        print("Response Text:", response.text)
    except Exception as e:
        print(f"Error posting data: {e}")

def receive_gps_data(host, port, interval=10):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        try:
            s.connect((host, port))
            print(f"Connected to {host}:{port}")

            buffer = ""

            while True:
                try:
                    data = s.recv(4096).decode('utf-8')
                    if not data:
                        print("No data received. Waiting for more data...")
                        time.sleep(interval)
                        continue

                    buffer += data
                    sentences = buffer.split('$')
                    buffer = sentences.pop()  # Save the last part to buffer

                    nmea_sentences = [f"${sentence.strip()}" for sentence in sentences if sentence.strip()]
                    for sentence in nmea_sentences:
                        print(sentence)

                    parsed_data = parse_nmea_sentences(nmea_sentences)
                    
                    # Check if GNGNS data is available
                    if parsed_data["GNGNS"] is not None:
                        # Calculate latitude and longitude values
                        latitude = convert_nmea_to_decimal(parsed_data["GNGNS"]["latitude"], parsed_data["GNGNS"]["latitude_direction"])
                        longitude = convert_nmea_to_decimal(parsed_data["GNGNS"]["longitude"], parsed_data["GNGNS"]["longitude_direction"])

                        # Create JSON body
                        json_body = {
                            "GNGNS_time": parsed_data["GNGNS"]["time"],
                            "GNGNS_latitude": latitude if latitude is not None else "",
                            "GNGNS_longitude": longitude if longitude is not None else "",
                            "GNGNS_altitude": parsed_data["GNGNS"]["altitude"],
                            "GNGNS_satellites": parsed_data["GNGNS"]["num_satellites"]
                        }
                    else:
                        # No GNGNS data available
                        json_body = {
                            "GNGNS_time": "",
                            "GNGNS_latitude": "",
                            "GNGNS_longitude": "",
                            "GNGNS_altitude": ""
                        }

                    # Convert JSON to string and print
                    json_data = json.dumps(json_body, indent=2)
                    print("JSON Data:", json_data)

                    # Send POST request with JSON body
                    post_data("http://harvest.soracom.io", json_body)

                    time.sleep(interval)
                except Exception as e:
                    print(f"Error receiving or sending data: {e}")
                    time.sleep(interval)
        except Exception as e:
            print(f"Error: {e}")

if __name__ == "__main__":
    host = '192.168.0.1'
    port = 50010
    receive_gps_data(host, port)

```
:::

1. parse_nmea_sentence(sentence)

GPSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸNMEAã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã®è§£èª­ã‚’è¡Œã†éƒ¨åˆ†ã«ãªã‚Šã¾ã™ã€‚
å®Ÿéš›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§ASCIIã§æ”¹è¡Œç„¡ã—ã§ãƒãƒƒãƒ•ã‚¡ã«ã‚¬ãƒ³ã‚¬ãƒ³æºœã¾ã£ã¦ãã¾ã™ã€‚
```
$GLGSV,3,3,09,78,14,250,*51$GPGGA,043957.00,3545.303666,N,13939.703979,E,1,09,0.7,65.2,M,39.0,M,,*56$GPGSV,3,3,12,19,65,319,44,22,34,222,35,11,11,279,,20,,,*47$GPRMC,043957.00,A,3545.303666,N,13939.703979,E,0.0,0.0,250524,5.0,W,A*29$GPVTG,0.0,T,5.0,M,0.0,N,0.0,K,A*26$GNGSA,A,3,,,,,,,,,,,,,1.1,0.7,0.8,3*3C$GNGNS,043957.00,3545.303666,N,13939.703979,E,AAN,13,0.7,65.2,39.0,,*27
```
ã“ã“ã§ã€$ã‹ã‚‰å§‹ã¾ã‚‹ã®ãŒå„ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯`GPGGA`ã€`GPRMC`ã€`GPVTG`ã€`GPGSV`ã€`GNGSA`ã€`GNGNS`ã€`GLGSV`ã‚ãŸã‚Šã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è§£èª­ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãã‚Œãã‚Œã®å€¤ãŒä½•ã®æ„å‘³ã‚’æŒã¤ã‹ï¼‰ã«ã¤ã„ã¦ã¯NMEA0183ã¨ã„ã†è¦æ ¼ã«å¾“ã£ã¦ã„ã¾ã™ã€‚
[ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸](https://www.nmea.org/nmea-0183.html)ã®ã€ŒINFORMATION, AMENDMENTS, CORRIGENDA, AND ERRATAã€ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«ã‚ã‚‹ã€ã€ŒTechnical Bulletin Navigation Satellite Systems Amendment to NMEA0183 Version 4.10 20180514ã€ã¨ã„ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
*1 ã“ã‚Œã¯ã“ã‚Œã§ãã®ã†ã¡å’Œè¨³ã—ã¦ãŠããŸã„
*2 ã“ã“ã®å‡¦ç†ã¯ãªã‚“ã‹ä½¿ã„ã‚„ã™ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šãã†ãªæ°—ãŒã™ã‚‹ã‘ã©è¦‹ã¤ã‹ã‚‰ãšãƒ»ãƒ»ãƒ»ï¼ˆçŸ¥ã£ã¦ã‚‹æ–¹ã„ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ï¼‰

2. parse_nmea_sentences(sentences)
ã“ã‚Œã¯ã€`def parse_nmea_sentence(sentence):`ã§parseã—ãŸNMEAã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã‚’ã‚ã¨ã§å–ã‚Šå‡ºã—ã‚„ã™ã„ã‚ˆã†ã«ä¸€ã¤ã«ã¾ã¨ã‚ã¦JSONå½¢å¼ã§ä¿ç®¡ã™ã‚‹å‡¦ç†ã§ã™ã€‚
å…¥åŠ›(sentences)ã¯ã€ãƒãƒƒãƒ•ã‚¡ã«æºœã¾ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’NMEAã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã”ã¨ã«æ ¼ç´ã—ãŸãƒªã‚¹ãƒˆã«ãªã‚Šã¾ã™ã€‚
```python
[
"$GLGSV,3,3,10,67,07,056,39,68,45,022,34*63",
"$GPGGA,093004.00,3545.296188,N,13939.709654,E,1,08,0.6,60.3,M,39.0,M,,*50",
"$GPGSV,3,3,11,29,23,274,,30,40,071,,50,,,44*76",
"$GLGSV,3,3,10,67,07,056,40,68,45,022,36*6F",
"$GPGGA,093005.00,3545.296190,N,13939.709654,E,1,08,0.6,60.3,M,39.0,M,,*58",
"$GPGSV,3,3,11,29,23,274,,30,40,071,,50,,,44*76",
"$GPRMC,093005.00,A,3545.296190,N,13939.709654,E,0.0,0.0,260524,5.0,W,A*20",
"$GPVTG,0.0,T,5.0,M,0.0,N,0.0,K,A*26",
"$GNGSA,A,3,,,,,,,,,,,,,0.9,0.6,0.6,3*3A",
"$GNGNS,093005.00,3545.296190,N,13939.709654,E,AAN,16,0.6,60.3,39.0,,*2D"
]
```
4. convert_nmea_to_decimal(degree_minutes, direction)
ç·¯åº¦è»½åº¦ã®æƒ…å ±ã‚’10é€²æ•°ã«å¤‰æ›ã™ã‚‹å‡¦ç†ã§ã™ã€‚
NMEAã‚»ãƒ³ãƒ†ãƒ³ã‚¹å†…ã®ç·¯åº¦è»½åº¦æƒ…å ±ã¯ã€`ddmm.mmmm`ãªã®ã§ã€60é€²ã‚’10é€²ã«å¤‰æ›ã™ã‚‹æ•°å¼ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚
ï¼ˆæœ€åˆã“ã‚Œã«æ°—ã¥ã‹ãšç›´æ„Ÿã§100å€ã—ãŸã¨ã“ã‚ã€åœ°å›³ã«ãƒ—ãƒ­ãƒƒãƒˆã—ãŸã‚‰ç´„40kmå ´æ‰€ãŒãšã‚Œã¦ã„ã¦æ°—ã¥ãã¾ã—ãŸã€‚ï¼‰
 
5. post_data(url, data)
ã©ã“ã‹ã®urlã«HTTP POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ã§ã™ã€‚
ç‰¹ã«å†é€ãªã©ã®å‡¦ç†ã¯å…¥ã‚Œã¦ã„ãªã„ã®ã§ã€å ´åˆã«ã‚ˆã£ã¦ã¯ä¿®æ­£ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚
(å¤±æ•—ã—ãŸã‚‰ãƒ­ã‚°ã«å‡ºã™ã ã‘)

6. receive_gps_data(host, port, interval=10)
ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹é–¢æ•°ã§ã™ã€‚
å¼•æ•°ã®host,portã¯R1520ã®GPS Serverã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã€ãƒãƒ¼ãƒˆç•ªå·ã‚’æ¸¡ã—ã¾ã™ã€‚
intervalã¯ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®é–“éš”ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10ç§’ã¨ã—ã¦ã‚ã‚Šã¾ã™ã€‚
GNSSè¡›æ˜Ÿã«ã‚ˆã‚‹æ¸¬ä½ã¯1ç§’ã«1å›è¡Œã‚ã‚Œã‚‹ã®ã§ã€intervalã®ç§’æ•°åˆ†ã®NMEAã‚»ãƒ³ãƒ†ãƒ³ã‚¹ãŒãƒãƒƒãƒ•ã‚¡ã«ãŸã¾ã‚Šã¾ã™ãŒã€`parse_nmea_sentences`ã®å‡¦ç†ã«ã‚ˆã‚Šã€ãƒãƒƒãƒ•ã‚¡ã«æºœã¾ã£ã¦ã„ã‚‹æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ¡ç”¨ã•ã‚Œã¾ã™ã€‚
```mermaid
graph TD
    A[é–‹å§‹] --> B[ã‚½ã‚±ãƒƒãƒˆã®ä½œæˆ]
    B --> C{ãƒ›ã‚¹ãƒˆã¨ãƒãƒ¼ãƒˆã«æ¥ç¶šã‚’è©¦ã¿ã‚‹}
    C -->|æˆåŠŸ| D[host:portã«æ¥ç¶šã—ã¾ã—ãŸã¨è¡¨ç¤º]
    C -->|å¤±æ•—| Z[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†]
    D --> E[ãƒãƒƒãƒ•ã‚¡ã®åˆæœŸåŒ–]
    E --> F[ãƒ«ãƒ¼ãƒ—é–‹å§‹]
    F --> G{ã‚½ã‚±ãƒƒãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã™ã‚‹}
    G -->|æˆåŠŸ| H[å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ ]
    G -->|å¤±æ•—| W[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦é–“éš”å¾…æ©Ÿ]
    H --> I[ãƒãƒƒãƒ•ã‚¡ã‚’'$'ã§åˆ†å‰²ã—ã¦å„æ–‡ã‚’å‡¦ç†]
    I --> J{ãƒãƒƒãƒ•ã‚¡ã«ä¸å®Œå…¨ãªæ–‡ãŒã‚ã‚‹ã‹}
    J -->|ã¯ã„| K[æœ€å¾Œã®éƒ¨åˆ†ã‚’æ¬¡å›ã®ãŸã‚ã«ãƒãƒƒãƒ•ã‚¡ã«ä¿å­˜]
    J -->|ã„ã„ãˆ| L[ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢]
    K --> L
    L --> M[parse_nmea_sentencesã§NMEAæ–‡ã‚’è§£æ]
    M --> N{GNGNSãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª}
    N -->|ã¯ã„| O[convert_nmea_to_decimalã§ç·¯åº¦ã¨çµŒåº¦ã‚’10é€²æ•°ã«å¤‰æ›]
    O --> P[JSONãƒœãƒ‡ã‚£ã®ä½œæˆ]
    P --> Q[JSONãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º]
    Q --> R[post_dataã§http://harvest.soracom.ioã«JSONãƒ‡ãƒ¼ã‚¿ã‚’POST]
    R --> S[ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º]
    N -->|ã„ã„ãˆ| T[ç©ºã®JSONãƒœãƒ‡ã‚£ã‚’ä½œæˆ]
    T --> Q
    S --> U[é–“éš”å¾…æ©Ÿ]
    U --> F
    W --> U
    Z --> A[çµ‚äº†]
```
å•é¡Œãªãæ¸¬ä½ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ãŒSORACOM Harvest Dataã«è“„ç©ã•ã‚Œã¦ã„ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/f057e7a46dea-20240527.png)

