---
title: "ã‚½ãƒ©ã‚«ãƒ¡ã§æ’®å½±ã—ãŸç”»åƒã‚’AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã§è§£æã™ã‚‹ï¼"
emoji: "ğŸ“·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ã‚½ãƒ©ã‚«ãƒ¡","IoT","AWS","rekognition","amplify"]
published: true
---

:::message
ã€Œ[ä¸€èˆ¬æ¶ˆè²»è€…ãŒäº‹æ¥­è€…ã®è¡¨ç¤ºã§ã‚ã‚‹ã“ã¨ã‚’åˆ¤åˆ¥ã™ã‚‹ã“ã¨ãŒå›°é›£ã§ã‚ã‚‹è¡¨ç¤º](https://www.caa.go.jp/policies/policy/representation/fair_labeling/guideline/assets/representation_cms216_230328_03.pdf)ã€ã®é‹ç”¨åŸºæº–ã«åŸºã¥ãé–‹ç¤º: ã“ã®è¨˜äº‹ã¯è¨˜è¼‰ã®æ—¥ä»˜æ™‚ç‚¹ã§[æ ªå¼ä¼šç¤¾ã‚½ãƒ©ã‚³ãƒ ](https://soracom.jp/)ã«æ‰€å±ã™ã‚‹ç¤¾å“¡ãŒåŸ·ç­†ã—ã¾ã—ãŸã€‚ãŸã ã—ã€å€‹äººã¨ã—ã¦ã®æŠ•ç¨¿ã§ã‚ã‚Šã€æ ªå¼ä¼šç¤¾ã‚½ãƒ©ã‚³ãƒ ã¨ã—ã¦ã®æ­£å¼ãªç™ºè¨€ã‚„è¦‹è§£ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::

## ã‚„ã‚ŠãŸã„ã“ã¨
ã‚½ãƒ©ã‚«ãƒ¡ã§æ’®å½±ã—ãŸç”»åƒã‚’AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦è§£æã—ã¦è¡¨ç¤ºã™ã‚‹ï¼
![alt text](/images/202505/image-47.png)

æ§‹æˆã¯ã“ã‚“ãªæ„Ÿã˜

![alt text](/images/202505/image-46.png)

## æº–å‚™
### å¿…è¦ãªã‚‚ã®
- SORACOM ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- ã‚½ãƒ©ã‚«ãƒ¡é–¢é€£
    - ã‚½ãƒ©ã‚«ãƒ¡ï¼ˆAtomCam2ï¼‰
    - Wifiç’°å¢ƒ
    - ã‚½ãƒ©ã‚«ãƒ¡ãƒ©ã‚¤ã‚»ãƒ³ã‚¹(å¸¸æ™‚éŒ²ç”»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ 7æ—¥é–“ãƒ—ãƒ©ãƒ³)  

:::details ã‚½ãƒ©ã‚«ãƒ¡ãŒåˆã‚ã¦ã®æ–¹ã¯ã“ã¡ã‚‰(è³¼å…¥ã‹ã‚‰è¨­ç½®ã¾ã§)ï¼

### SORACOMã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãªã©
https://users.soracom.io/ja-jp/guides/getting-started/create-account/

ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¿ã‚¤ãƒ—ã¯JPã§ã€‚

### ã‚½ãƒ©ã‚«ãƒ¡ã®è³¼å…¥ã€œã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¾ã§

https://sora-cam.com/setup/

å®Ÿã¯æœ€è¿‘ã¯ã‚½ãƒ©ã‚«ãƒ¡ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã‚¢ãƒ—ãƒªã‚’ä½¿ã‚ãªãã¦ã‚‚è‰¯ããªã£ã¦ã„ãŸã‚Šã™ã‚‹ã€‚

### ã‚½ãƒ©ã‚«ãƒ¡ã®è¨­ç½®

è¨­ç½®ã«é–¢ã™ã‚‹çŸ¥è¦‹ã¯ã“ã“ã«ãŸãã•ã‚“æºœã¾ã£ã¦ã„ã¾ã™ã€‚
https://weathernews.jp/s/topics/202403/180215/

:::
- AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- Wordpressã®ç’°å¢ƒ

## ã‚«ãƒ¡ãƒ©ãƒã‚§ãƒƒã‚¯
![alt text](/images/soracamimagetos3towp/image-25.png)
ä½•ã¯ã¨ã‚‚ã‚ã‚Œã€ã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

ã€Œã‚½ãƒ©ã‚³ãƒ ã‚¯ãƒ©ã‚¦ãƒ‰ã‚«ãƒ¡ãƒ©ã‚µãƒ¼ãƒ“ã‚¹ã€ -> ã€Œãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ã€

![alt text](/images/soracamimagetos3towp/image.png)

ãƒ‡ãƒã‚¤ã‚¹ã®ä¸€è¦§è¡¨ç¤ºã§ã€å…ˆã»ã©ç™»éŒ²ã—ãŸã‚«ãƒ¡ãƒ©ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![alt text](/images/soracamimagetos3towp/image-1.png)

ã•ã‚‰ã«ã€ã‚«ãƒ¡ãƒ©ã®åå‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚«ãƒ¡ãƒ©ã®æ˜ åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![alt text](/images/soracamimagetos3towp/image-2.png)

:::message
ã“ã®ç”»é¢ã‚’è¦‹ç¶šã‘ã¦ã„ã‚‹ã¨æœˆ72æ™‚é–“ã¾ã§ã®å‹•ç”»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚é–“ç„¡æ–™æ ã‚’æ¶ˆè²»ã—ã¦ã—ã¾ã†ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚
:::

## SORACOM APIã‚­ãƒ¼ã‚’ç™ºè¡Œã™ã‚‹
![alt text](/images/soracamimagetos3towp/image-26.png)
ã‚½ãƒ©ã‚«ãƒ¡ã®éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”»åƒã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€SORACOM APIã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€APIã‚­ãƒ¼ã‚’ç™ºè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§ã€ä»¥ä¸‹ã®æ‰‹é †ã§APIã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¾ã—ã‚‡ã†ã€‚
1. å³ä¸Šã®ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚Œã°ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€SAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚Œã°SAMãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‡ºã¦ãã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    ![alt text](/images/soracamimagetos3towp/image-3.png)

2. ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚¿ãƒ–ã§ã€ŒSAMãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    ![alt text](/images/soracamimagetos3towp/image-4.png)

3. å¾Œã§è¦‹ãŸã¨ãã«ä½•ã‚’ã™ã‚‹ãŸã‚ã®SAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«åå‰ã‚’ã¤ã‘ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦æ¦‚è¦ã«ã‚‚è¨˜è¼‰ã—ã¦ã€Œä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-6.png)

4. ä½œã£ãŸSAMãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã€åå‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-7.png)

5. æ¨©é™ã‚’è¨­å®šã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-8.png)
    ç›´æ¥æŒ‡å®šã§ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚

    ```json
    {
     "statements": [
        {
        "api": [
            "SoraCam:exportSoraCamDeviceRecordedImage",
            "SoraCam:getSoraCamDeviceExportedImage",
            "OAuth2:authorize"
        ],
        "effect": "allow"
        }
    ]
    }
    ```

6. ã€Œèªè¨¼è¨­å®šã€ã®ã‚¿ãƒ–ã«ç§»ã‚Šã€ã€Œèªè¨¼ã‚­ãƒ¼ã‚’ç”Ÿæˆã€ä½œæˆã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-9.png)

7. ç”Ÿæˆã•ã‚ŒãŸèªè¨¼ã‚­ãƒ¼ã‚’ãƒ¡ãƒ¢å¸³ãªã©ã«ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãŠãã¾ã™ã€‚
    ç”»é¢ã‚’é–‰ã˜ã¦ã—ã¾ã†ã¨å†åº¦è¡¨ç¤ºã•ã‚Œãªã„ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
    ![alt text](/images/soracamimagetos3towp/image-10.png)

## S3ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹

![alt text](/images/soracamimagetos3towp/image-27.png)

ã‚½ãƒ©ã‚«ãƒ¡ã®éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸç”»åƒã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
1. AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€S3ã‚’é–‹ãã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-11.png)

2. ã€Œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-12.png)

3. ãƒã‚±ãƒƒãƒˆã‚¿ã‚¤ãƒ—ï¼šæ±ç”¨ã€ãƒã‚±ãƒƒãƒˆåï¼šä»»æ„ã®åå‰ï¼ˆä¾‹ï¼šsoracam-image-bucketç­‰ã€‚ä¸–ç•Œã«ä¸€ã¤ã ã‘ã®ç‰¹åˆ¥ãªã‚ªãƒ³ãƒªãƒ¼ãƒ¯ãƒ³ã®åå‰ï¼‰ã‚’è¨­å®š
    ![alt text](/images/soracamimagetos3towp/image-16.png)

4. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ‰€æœ‰è€…ï¼šACLç„¡åŠ¹ã€ã€Œãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯ã€ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¤–ã—ã€warningã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã„ã‚Œã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-14.png)

5. ãã®ä»–ã®é …ç›®ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã«ã—ã¦ã€Œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-15.png)

6. ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ãƒã‚±ãƒƒãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-17.png)
    ![alt text](/images/soracamimagetos3towp/image-18.png)

7. ç”»åƒã‚’ä¿å­˜ã—ã¦ãŠããŸã‚ã®ã€Œlive-cameraã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-21.png)
    ![alt text](/images/soracamimagetos3towp/image-22.png)
    ã€Œãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-23.png)

7. ãƒã‚±ãƒƒãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã€Œã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã®ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-19.png)

8. ãƒ‘ã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã‚’ãƒãƒªã‚·ãƒ¼ã®ç·¨é›†æ¬„ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-20.png)
    ä»¥ä¸‹ã®JSONã‚’ã‚³ãƒ”ãƒšã—ã¦ã€ãƒã‚±ãƒƒãƒˆåã®éƒ¨åˆ†ã‚’è¨­å®šã—ãŸã‚‚ã®ã«æ›¸ãæ›ãˆã¾ã—ã‚‡ã†ã€‚
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::ä¸–ç•Œã«ä¸€ã¤ã ã‘ã®ãƒã‚±ãƒƒãƒˆå/live-camera/*"
            }
        ]
    }
    ```
    ä¿å­˜ã—ã¦é–‰ã˜ã¾ã™ã€‚


## Lambdaé–¢æ•°ã‚’ä½œæˆã™ã‚‹
SORACOM APIã®èªè¨¼ã‚’è¡Œã„ã€ã‚½ãƒ©ã‚«ãƒ¡ã®éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”»åƒã‚’å–å¾—ã—ã€S3ã«ä¿å­˜ã™ã‚‹Lambdaé–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

![alt text](/images/soracamimagetos3towp/image-28.png)

ã‚½ãƒ©ã‚«ãƒ¡ã®éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”»åƒã‚’å–å¾—ã™ã‚‹ãŸã‚ã®Lambdaé–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚
1. AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€Lambdaã‚’é–‹ãã¾ã™ã€‚

2. ã€Œé–¢æ•°ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-29.png)

3. ã€Œä¸€ã‹ã‚‰ä½œæˆã€ã‚’é¸æŠã€ã€Œé–¢æ•°åã€ã‚’å…¥åŠ›ã—ã€ã€Œãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã€ã¯ã€ŒPython 3.12ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€Œarmã€ã‚’é¸æŠã—ã€ã€Œé–¢æ•°ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-30.png)

4. é–¢æ•°ã®ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ãŸã‚‰ã€
    ![alt text](/images/soracamimagetos3towp/image-31.png)

5. ã€Œã‚³ãƒ¼ãƒ‰ã‚½ãƒ¼ã‚¹ã€ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚
    ```python
    import json
    import os
    import time
    import datetime
    import urllib.request
    import urllib.parse
    import boto3

    # ç’°å¢ƒå¤‰æ•°ã®å–å¾—
    AUTH_KEY_ID = os.environ['authKeyId']
    AUTH_KEY = os.environ['authKey']
    DEVICE_ID = os.environ['device_id']
    S3_BUCKET = 'ãƒã‚±ãƒƒãƒˆå'
    S3_FOLDER = 'live-camera' 

    def lambda_handler(event, context):
        try:
            # 1. èªè¨¼ã—ã¦APIã‚­ãƒ¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹
            auth_response = authenticate()
            api_key = auth_response['apiKey']
            api_token = auth_response['token']

            # 2. ç”»åƒã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
            export_id = request_image_export(api_key, api_token)
        
            # 3. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®é€²æ—ã‚’ç¢ºèªã™ã‚‹
            image_url = check_export_status(api_key, api_token, export_id)

            # 4. S3ã«ç”»åƒã‚’ä¿å­˜ã™ã‚‹
            save_image_to_s3(image_url)
        
            return {
                'statusCode': 200,
                'body': json.dumps('Image successfully saved to S3')
            }
        
        except Exception as e:
            return {
                'statusCode': 500,
                'body': json.dumps(f'Error: {str(e)}')
            }

    # èªè¨¼ã‚’è¡Œã„ã€APIã‚­ãƒ¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    def authenticate():
        url = 'https://api.soracom.io/v1/auth'
        headers = {
            'Content-Type': 'application/json'
        }
        data = json.dumps({
            'authKeyId': AUTH_KEY_ID,
            'authKey': AUTH_KEY
        }).encode('utf-8')
    
        req = urllib.request.Request(url, headers=headers, data=data, method='POST')
        with urllib.request.urlopen(req) as response:
            if response.status != 200:
                raise Exception(f'Authentication failed: {response.status}')
            return json.loads(response.read().decode('utf-8'))

    # ç”»åƒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
    def request_image_export(api_key, api_token):
        url = f'https://api.soracom.io/v1/sora_cam/devices/{DEVICE_ID}/images/exports'
        headers = {
            'Content-Type': 'application/json',
            'X-Soracom-API-Key': api_key,
            'X-Soracom-Token': api_token
        }
        current_time = int(time.time() * 1000)  # ç¾åœ¨ã®UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒŸãƒªç§’ï¼‰
        data = json.dumps({'time': current_time}).encode('utf-8')
    
        req = urllib.request.Request(url, headers=headers, data=data, method='POST')
        with urllib.request.urlopen(req) as response:
            if response.status != 200:
                raise Exception(f'Image export request failed: {response.status}')
            export_response = json.loads(response.read().decode('utf-8'))
            return export_response['exportId']

    # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®é€²æ—ã‚’ç¢ºèªã™ã‚‹
    def check_export_status(api_key, api_token, export_id):
        url = f'https://api.soracom.io/v1/sora_cam/devices/{DEVICE_ID}/images/exports/{export_id}'
        headers = {
            'Content-Type': 'application/json',
            'X-Soracom-API-Key': api_key,
            'X-Soracom-Token': api_token
        }
    
        retry_intervals = [1, 2, 4]  # ãƒªãƒˆãƒ©ã‚¤ã®é–“éš”
        for interval in retry_intervals:
            req = urllib.request.Request(url, headers=headers, method='GET')
            with urllib.request.urlopen(req) as response:
                if response.status != 200:
                    raise Exception(f'Check export status failed: {response.status}')
                status_response = json.loads(response.read().decode('utf-8'))
            
                # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ãŸå ´åˆã¯URLã‚’è¿”ã™
                if status_response['status'] == 'completed':
                    return status_response['url']
        
            # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
            time.sleep(interval)
    
        raise Exception('Image export not completed within allowed retries')

    # ç”»åƒã‚’S3ã«ä¿å­˜ã™ã‚‹
    def save_image_to_s3(image_url):
        # ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        req = urllib.request.Request(image_url, method='GET')
        with urllib.request.urlopen(req) as response:
            if response.status != 200:
                raise Exception(f'Failed to download image: {response.status}')
            image_data = response.read()
    
        # S3ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã‚’ä½œæˆ (JSTæ™‚åˆ»)
        jst = datetime.timezone(datetime.timedelta(hours=9))
        current_time = datetime.datetime.now(jst)
        object_name = current_time.strftime('%Y%m%d_%H%M.jpg')
    
        # S3ã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        s3_client = boto3.client('s3')
        s3_client.put_object(
            Bucket=S3_BUCKET,
            Key=f'{S3_FOLDER}/{object_name}',
            Body=image_data,
            ContentType='image/jpeg'
        )
    ```
6. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚
   è¨­å®šã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œç’°å¢ƒå¤‰æ•°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã€Œç·¨é›†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-32.png)    
    - authKeyId: å…ˆã»ã©ç™ºè¡Œã—ãŸSORACOM APIã‚­ãƒ¼ã®ID
    - authKey: å…ˆã»ã©ç™ºè¡Œã—ãŸSORACOM APIã‚­ãƒ¼
    - device_id: ã‚½ãƒ©ã‚«ãƒ¡ã®ãƒ‡ãƒã‚¤ã‚¹ID
    ![alt text](/images/soracamimagetos3towp/image-33.png)

7. å…¥åŠ›ã—ãŸã‚‰ã€ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

8. ã€Œä¸€èˆ¬è¨­å®šã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œç·¨é›†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’20ç§’ã«è¨­å®šã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-34.png)

9. ã€Œã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œãƒ­ãƒ¼ãƒ«åã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ­ãƒ¼ãƒ«ã®ç·¨é›†ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-35.png)

10. ã€Œè¨±å¯ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-36.png)

11. ã€ŒJSONã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚³ãƒ”ãƒšã—ã¦ã€Œãƒãƒªã‚·ãƒ¼ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": "s3:PutObject",
                "Resource": "arn:aws:s3:::ä¸–ç•Œã«ä¸€ã¤ã ã‘ã®ãƒã‚±ãƒƒãƒˆå/live-camera/*"
            }
        ]
    }
    ```
    ![alt text](/images/soracamimagetos3towp/image-37.png)

12. ã€Œãƒãƒªã‚·ãƒ¼ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-38.png)

13. ã€ŒDeployã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Lambdaé–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

14. ã€ŒTestã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€é©åˆ‡ãªã‚¤ãƒ™ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã€‚
    ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆJSONã¯ç·¨é›†ä¸è¦ã§ã™ã€‚ï¼‰
    ![alt text](/images/soracamimagetos3towp/image-39.png)

15. ã€Œå‘¼ã³å‡ºã™ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Lambdaé–¢æ•°ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
    ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºãŒå‡ºã¦ã‚Œã°æˆåŠŸã§ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-40.png)

## ç”»åƒã‚’S3ã«ä¿å­˜ã™ã‚‹Lambdaé–¢æ•°ã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹EventBridgeãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹
å®šæœŸçš„ã«SORACOM APIã‚’å‘¼ã³å‡ºã—ã¦ç”»åƒã‚’å–å¾—ã—ã€S3ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®EventBridgeãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

ã¤ã„ã«ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚
![alt text](/images/soracamimagetos3towp/image-41.png)

1. é–¢æ•°ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ã€Œãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-42.png)

2. ã€Œãƒˆãƒªã‚¬ãƒ¼ã®è¿½åŠ ã€ç”»é¢ã§ã€ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã®é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€ŒEvent Bridgeï¼ˆCloudWatch Eventsï¼‰ã€ã‚’é¸æŠã—ã¾ã™ã€‚
    ![alt text](/images/soracamimagetos3towp/image-43.png)

3. ã€Œæ–°è¦ãƒ«ãƒ¼ãƒ«ã®ä½œæˆã€ã‚’é¸æŠã—ã€ã€Œãƒ«ãƒ¼ãƒ«åã€ã‚’å…¥åŠ›ã—ã€ã€Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¼ã€ã‚’å…¥åŠ›ã—è¿½åŠ ã—ã¾ã™ã€‚
    ä¾‹ï¼š`rate(1 minute)`ï¼ˆ1åˆ†ã”ã¨ã«å®Ÿè¡Œï¼‰
    ![alt text](/images/soracamimagetos3towp/image-44.png)
    ![alt text](/images/soracamimagetos3towp/image-45.png)

## S3ã«ä¿å­˜ã•ã‚ŒãŸç”»åƒã‚’webã‚¢ãƒ—ãƒªã§è¡¨ç¤ºã™ã‚‹

1. ä¸‹è¨˜ã‹ã‚‰ã‚¢ãƒ—ãƒªï¼ˆzipãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
    https://github.com/takao2704/public-zenn-docs/raw/refs/heads/main/files/soracam-viewer.zip
    
2.    AWS Amplifyã‚’é–‹ãã¾ã™ã€‚
    ![alt text](/images/202505/image-43.png)

3. ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãã¾ã™ã€‚
    ã€Œæ–°ã—ã„ã‚¢ãƒ—ãƒªã‚’ä½œæˆã€ã‹ã‚‰ã€ŒGitãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’é¸æŠã—ã¦ã€Œæ¬¡ã¸ã€ã€‚
    ![alt text](/images/202505/image-44.png)

4. zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åç§°ï¼ˆä»»æ„ï¼‰ã‚’è¨­å®šã—ã¦ã€ã€Œãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ã€Œä¿å­˜ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã€‚
    ï¼ˆ1.ã®URLã‚’ç›´å…¥åŠ›ã—ã¦ã‚‚OKã§ã™ã€‚ï¼‰

5. ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰ã€URLã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

6. S3ãƒã‚±ãƒƒãƒˆåã¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€Œè¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ä¸Šæ®µã®æ å†…ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰æˆåŠŸã§ã™ï¼ˆä¸‹æ®µã¯ã“ã‚Œã‹ã‚‰ä½œã‚Šè¾¼ã‚“ã§ã„ãã¾ã™ã®ã§ã¾ã è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰
    ![alt text](/images/202505/image-48.png)

## ã‚½ãƒ©ã‚«ãƒ¡ã®ç”»åƒã‚’Amazon Rekognitionã§è§£æã™ã‚‹

1. AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Lambdaé–¢æ•°ã‚’ä½œæˆ
   - ãƒ©ãƒ³ã‚¿ã‚¤ãƒ : `Python 3.13`
   - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: `arm64`

2. ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ 
   - ä¸‹è¨˜ã®Lambdaé–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ãƒšãƒ¼ã‚¹ãƒˆã§è²¼ã‚Šä»˜ã‘
```python
import json
import boto3
import os
import urllib.parse
from datetime import datetime
from io import BytesIO
from PIL import Image, ImageDraw, ImageFont

# Python 3.13 ARM64ç”¨ã«æœ€é©åŒ–

# AWS ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
REGION = 'ap-northeast-1'  # æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
s3_client = boto3.client('s3', region_name=REGION)
rekognition_client = boto3.client('rekognition', region_name=REGION)

# ç’°å¢ƒå¤‰æ•°
MIN_CONFIDENCE = float(os.environ.get('MIN_CONFIDENCE', 70.0))  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿¡é ¼åº¦é–¾å€¤: 70%
OUTPUT_PREFIX = os.environ.get('OUTPUT_PREFIX', 'analyzed-images/')  # å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

# ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®è¨­å®š
LABEL_FONT_SIZE = 24  # ãƒ©ãƒ™ãƒ«ãƒªã‚¹ãƒˆç”¨ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
BOX_FONT_SIZE = 20    # ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç”¨ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º

def lambda_handler(event, context):
    try:
        # S3ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒã‚±ãƒƒãƒˆåã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ¼ã‚’å–å¾—
        bucket = event['Records'][0]['s3']['bucket']['name']
        object_key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'])
        
        print(f"Processing image: {object_key} from bucket: {bucket}")
        
        # ç”»åƒã®å®Œå…¨ãªS3ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
        s3_path = f"https://{bucket}.s3.{REGION}.amazonaws.com/{object_key}"
        
        # S3ã‹ã‚‰ç”»åƒã‚’å–å¾—
        response = s3_client.get_object(Bucket=bucket, Key=object_key)
        image_content = response['Body'].read()
        
        # Rekognitionã§ãƒ©ãƒ™ãƒ«æ¤œå‡º
        rekognition_response = rekognition_client.detect_labels(
            Image={
                'S3Object': {
                    'Bucket': bucket,
                    'Name': object_key
                }
            },
            MinConfidence=MIN_CONFIDENCE
        )
        
        # Rekognitionã®çµæœã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›
        print(f"Rekognitionçµæœå…¨ä½“: {json.dumps(rekognition_response, indent=2, default=str)}")
        
        # ãƒ©ãƒ™ãƒ«ã”ã¨ã«Instancesã®æœ‰ç„¡ã‚’ç¢ºèª
        for label in rekognition_response['Labels']:
            label_name = label['Name']
            confidence = label['Confidence']
            instances_count = len(label.get('Instances', []))
            print(f"ãƒ©ãƒ™ãƒ«: {label_name}, ä¿¡é ¼åº¦: {confidence:.1f}%, Instancesæ•°: {instances_count}")
            
            # InstancesãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
            if instances_count > 0:
                for i, instance in enumerate(label['Instances']):
                    if 'BoundingBox' in instance:
                        box = instance['BoundingBox']
                        print(f"  Instance {i+1}: BoundingBox = {box}")
        
        # PILã§ç”»åƒã‚’é–‹ã
        image = Image.open(BytesIO(image_content))
        draw = ImageDraw.Draw(image)
        
        # ãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š
        # å¤ã„PILãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€try-exceptã§å‡¦ç†
        try:
            # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PIL
            label_font = ImageFont.load_default(size=LABEL_FONT_SIZE)
            box_font = ImageFont.load_default(size=BOX_FONT_SIZE)
        except TypeError:
            # å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PIL - ã‚µã‚¤ã‚ºæŒ‡å®šãªã—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆ
            print("Warning: Using default font without size specification")
            label_font = ImageFont.load_default()
            box_font = ImageFont.load_default()
        
        # ç”»åƒã®å¹…ã¨é«˜ã•ã‚’å–å¾—
        width, height = image.size
        
        # æ¤œå‡ºã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ã¨ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’æç”»
        for label in rekognition_response['Labels']:
            label_name = label['Name']
            confidence = label['Confidence']
            
            # ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆã¯æç”»
            for instance in label.get('Instances', []):
                if 'BoundingBox' in instance:
                    box = instance['BoundingBox']
                    left = int(box['Left'] * width)
                    top = int(box['Top'] * height)
                    box_width = int(box['Width'] * width)
                    box_height = int(box['Height'] * height)
                    
                    # çŸ©å½¢ã‚’æç”»
                    draw.rectangle(
                        [(left, top), (left + box_width, top + box_height)],
                        outline='red',
                        width=3
                    )
                    
                    # ãƒ©ãƒ™ãƒ«åã¨ä¿¡é ¼åº¦ã‚’æç”»
                    text = f"{label_name}: {confidence:.1f}%"
                    draw.text((left, top - 30), text, fill='red', font=box_font)
        
        # ç”»åƒã®ä¸Šéƒ¨ã«æ¤œå‡ºã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ã®ä¸€è¦§ã‚’è¡¨ç¤º
        y_position = 10
        for label in rekognition_response['Labels']:
            label_name = label['Name']
            confidence = label['Confidence']
            text = f"{label_name}: {confidence:.1f}%"
            draw.text((10, y_position), text, fill='blue', font=label_font)
            y_position += LABEL_FONT_SIZE + 10  # ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦é–“éš”ã‚’èª¿æ•´
        
        # å‡¦ç†æ¸ˆã¿ç”»åƒã‚’ãƒã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¤‰æ›
        output_image = BytesIO()
        image.save(output_image, format='JPEG')
        output_image.seek(0)
        
        # å‡ºåŠ›å…ˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ¼ã‚’ç”Ÿæˆ
        filename = object_key.split('/')[-1]
        output_key = f"{OUTPUT_PREFIX}{filename}"
        
        # å‡¦ç†æ¸ˆã¿ç”»åƒã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        s3_client.put_object(
            Bucket=bucket,
            Key=output_key,
            Body=output_image,
            ContentType='image/jpeg'
        )
        
        print(f"Processed image saved to: {output_key}")
        
        return {
            'statusCode': 200,
            'body': json.dumps(f'Successfully processed image {object_key} and saved to {output_key}')
        }
        
    except Exception as e:
        print(f"Error: {str(e)}")
        return {
            'statusCode': 500,
            'body': json.dumps(f'Error processing image: {str(e)}')
        }
```

3. Pillowãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
    - ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        https://github.com/takao2704/public-zenn-docs/raw/refs/heads/main/files/pillow-layer.zip
    - æä¾›ã•ã‚ŒãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`pillow-layer.zip`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
        ![alt text](/images/202505/image-51.png)
    - ä½œæˆã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’Lambdaé–¢æ•°ã«è¿½åŠ 
        é–¢æ•°ã®è¨­å®šç”»é¢ã®ã€Œã‚³ãƒ¼ãƒ‰ã€ã‚¿ãƒ–ã‚’é–‹ãã€ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ ã‚’ã‚¯ãƒªãƒƒã‚¯
        ![alt text](/images/202505/image-52.png)

4. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
   - `MIN_CONFIDENCE`: `70.0`
   - `OUTPUT_PREFIX`: `analyzed-images/` S3ã«è§£æå¾Œã®ç”»åƒã‚’ä¿å­˜ã™ã‚‹éš›ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå)

5. ãƒ¡ãƒ¢ãƒªã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è¨­å®š
   - ãƒ¡ãƒ¢ãƒª: `256 MB`
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: `30 ç§’`

6. IAMãƒ­ãƒ¼ãƒ«ã®è¨­å®š
Lambdaé–¢æ•°ã®IAMãƒãƒªã‚·ãƒ¼ã‚’æ›´æ–°ã—ã¦ã€S3ã¨Rekognitionã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚

    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:GetObject",
                    "s3:PutObject"
                ],
                "Resource": "arn:aws:s3:::your-bucket-name/*"
            },
            {
                "Effect": "Allow",
                "Action": [
                    "rekognition:DetectLabels"
                ],
                "Resource": "*"
            }
        ]
    }
    ```

7. S3ã®ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã®æ›´æ–°
    è§£æå¾Œã®ç”»åƒã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚å¯¾è±¡ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": [
                    "arn:aws:s3:::ä¸–ç•Œã«ä¸€ã¤ã ã‘ã®ãƒã‚±ãƒƒãƒˆå/live-camera/*",
                    "arn:aws:s3:::ä¸–ç•Œã«ä¸€ã¤ã ã‘ã®ãƒã‚±ãƒƒãƒˆå/analyzed-images/*"
                ]
            }
        ]
    }
    ```
8. S3ã®ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
    - lambdaé–¢æ•°ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ 
    - S3ã‚’é¸æŠ
    - ãƒã‚±ãƒƒãƒˆåã‚’é¸æŠ
    - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’ã€Œã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¤ãƒ™ãƒ³ãƒˆã€ã«è¨­å®š
    - ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«`live-camera/`ã‚’æŒ‡å®š
    - ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«`.jpg`ã‚’æŒ‡å®š
    - ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    ![alt text](/images/202505/image-50.png)
    ![alt text](/images/202505/image-49.png)

## ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹
ã‚¢ãƒ—ãƒªã«è§£æå‰ã¨è§£æå¾Œã®ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

1. å…ˆã»ã©amplifyã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ 

2. S3ãƒã‚±ãƒƒãƒˆåã¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€Œè¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    ![alt text](/images/202505/image-47.png)



